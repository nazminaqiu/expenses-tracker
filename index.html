<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Monthly Expense Tracker</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/plugins/monthSelect/style.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, deleteDoc, updateDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // ==================================================================================
        // ====> ACTION: PASTE YOUR FIREBASE CONFIGURATION OBJECT FROM THE FIREBASE CONSOLE HERE
        // ==================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAgEXmz8rUKAUFFukKgKKromV03okUmfFQ",
            authDomain: "expenses-tracker-8725f.firebaseapp.com",
            projectId: "expenses-tracker-8725f",
            storageBucket: "expenses-tracker-8725f.firebasestorage.app",
            messagingSenderId: "717743221463",
            appId: "1:717743221463:web:d574feaf383b06a380de92",
            measurementId: "G-VN0F315CZF"
        };
        // ==================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.db = db;
        window.storage = storage;
        window.fb = { collection, addDoc, onSnapshot, doc, getDoc, deleteDoc, updateDoc, query, orderBy, ref, uploadBytesResumable, getDownloadURL, deleteObject, setDoc };
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; animation: fadeInDown 0.5s ease; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; animation: fadeInUp 0.5s ease; }
        .tabs { display: flex; background: #f7f9fc; border-bottom: 1px solid #e1e8ed; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; background: none; border: none; font-size: 16px; font-weight: 600; color: #657786; transition: all 0.3s ease; position: relative; }
        .tab:hover { background: rgba(102, 126, 234, 0.05); }
        .tab.active { color: #667eea; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { width: 0; left: 50%; } to { width: 100%; left: 0; } }
        .content { padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; background-color: white; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .file-upload { position: relative; display: flex; align-items: center; }
        .file-upload input[type=file] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-upload-label { display: block; flex-grow: 1; padding: 12px; border: 2px dashed #667eea; border-radius: 10px; text-align: center; color: #667eea; font-weight: 600; transition: all 0.3s ease; }
        .file-upload-label[contenteditable]:focus { outline: none; }
        .file-upload-label[contenteditable]:empty::before { content: '📋 Paste Image Here'; color: #667eea; }
        .file-upload:hover .file-upload-label { background: rgba(102, 126, 234, 0.05); border-color: #764ba2; }
        #file-label-selected { color: #2c3e50; font-weight: normal; font-style: italic; }
        .remove-file-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 18px; line-height: 28px; cursor: pointer; margin-left: -40px; z-index: 2; transition: all 0.2s ease; }
        .remove-file-btn:hover { background: #c0392b; transform: scale(1.1); }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: #b0bec5; cursor: not-allowed; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(0); transition: all 0.3s ease; cursor: help; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .summary-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .summary-card .amount { font-size: 32px; font-weight: 700; }
        .expenses-list { background: #f7f9fc; border-radius: 15px; padding: 20px; }
        .expense-item { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; animation: slideInLeft 0.4s ease; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .expense-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: translateX(5px); }
        .expense-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .expense-category { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: capitalize; letter-spacing: 0.5px; background: #dfe6e9; color: #2d3436; }
        .expense-amount { font-size: 24px; font-weight: 700; color: #2c3e50; }
        .expense-details { color: #657786; font-size: 14px; line-height: 1.6; white-space: pre-wrap; word-wrap: break-word; }
        .expense-details img { max-width: 100px; border-radius: 5px; margin: 10px 10px 0 0; border: 2px solid #e1e8ed; cursor: pointer; transition: transform 0.2s; }
        .expense-details img:hover { transform: scale(1.05); }
        .expense-date { color: #8898aa; font-size: 13px; margin-top: 10px; }
        .receipt-link { color: #667eea; text-decoration: none; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; margin-top: 10px; transition: color 0.3s ease; }
        .receipt-link:hover { color: #764ba2; }
        .receipt-link::before { content: "📎"; margin-right: 5px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; margin-top: 10px; }
        .delete-btn:hover { background: #c0392b; transform: scale(1.05); }
        .filter-section { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select {
            flex: 1;
            min-width: 150px;
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-color: white;
            background-image: url('data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23657786%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E');
            background-repeat: no-repeat;
            background-position: right 1em top 50%;
            background-size: .65em auto;
            padding-right: 2.5em;
        }
        .no-expenses { text-align: center; padding: 60px 20px; color: #8898aa; }
        .no-expenses-icon { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        .export-btn { background: linear-gradient(135deg, #00b894, #00cec9); margin-left: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease; max-height: 90vh; overflow-y: auto; }
        .modal-header { padding: 20px 30px; flex-shrink: 0; border-bottom: 1px solid #e1e8ed; display: flex; justify-content: space-between; align-items: center; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #8898aa; }
        #image-modal .modal-close-btn { position: absolute; top: 15px; right: 15px; font-size: 30px; color: white; background: rgba(0,0,0,0.5); border-radius: 50%; width: 40px; height: 40px; line-height: 40px; text-align: center; }
        .modal-body { padding: 20px 30px; }
        .modal-buttons { padding: 20px 30px; flex-shrink: 0; border-top: 1px solid #e1e8ed; display: flex; gap: 10px; }
        .progress-bar-container { width: 100%; height: 10px; background-color: #e1e8ed; border-radius: 5px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        #icon-preset-grid, #edit-icon-preset-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .icon-preset { font-size: 24px; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .icon-preset:hover { transform: scale(1.1); border-color: #a29bfe; }
        .icon-preset.selected { border-color: #667eea; background-color: rgba(102, 126, 234, 0.1); transform: scale(1.1); }
        #existing-receipt-container { margin-bottom: 10px; }
        .category-breakdown-item { display: flex; justify-content: space-between; align-items: center; }
        .category-actions { display: flex; gap: 10px; align-items: center; }
        .view-toggle { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; gap: 15px; flex-wrap: wrap; }
        .view-btn { padding: 8px 16px; font-size: 14px; background: white; color: #667eea; border: 2px solid #e1e8ed; box-shadow: none; }
        .view-btn:hover { background: rgba(102, 126, 234, 0.05); transform: translateY(0); box-shadow: none; }
        .view-btn.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border-color: transparent; }
        .budget-item { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; align-items: center; }
        .budget-item-details { grid-column: 1 / -1; }
        .budget-progress-bar-container { height: 12px; background: #e1e8ed; border-radius: 6px; overflow: hidden; margin: 10px 0; }
        .budget-progress-bar { height: 100%; transition: width 0.4s ease, background-color 0.4s ease; }
        .budget-progress-bar.normal { background: linear-gradient(90deg, #667eea, #764ba2); }
        .budget-progress-bar.over { background: linear-gradient(90deg, #ff7675, #d63031); }
        .budget-info { display: flex; justify-content: space-between; font-size: 14px; margin-top: 5px; color: #657786; }
        .budget-remaining.negative { color: #d63031; font-weight: 700; }
        .budget-input-group { display: flex; align-items: center; gap: 10px; }
        .budget-input-group input { flex-grow: 1; }
        .btn-small { padding: 10px 15px; font-size: 14px; }
        #receipt-preview-container { margin-top: 15px; text-align: center; }
        #receipt-preview-container img { max-width: 100%; max-height: 200px; border-radius: 10px; border: 2px solid #e1e8ed; }

        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            .content { padding: 20px 15px; }
            .header h1 { font-size: 1.8em; }
            .summary-cards { grid-template-columns: 1fr; }
            .expense-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .tabs { overflow-x: auto; -webkit-overflow-scrolling: touch; }
            .tabs::-webkit-scrollbar { height: 4px; }
            .tabs::-webkit-scrollbar-thumb { background: #dcdde1; border-radius: 2px; }
            .tab { flex-shrink: 0; min-width: 110px; }
            .category-breakdown-item { flex-direction: column; align-items: flex-start; gap: 15px; }
            .category-breakdown-item > div:first-child { width: 100%; }
            .custom-category-item { flex-direction: column; align-items: flex-start; }
            .category-actions { width: 100%; margin-top: 15px; flex-direction: column-reverse; align-items: stretch; gap: 10px; }
            .category-actions .btn, .category-actions .delete-btn { margin: 0; text-align: center; }
            .budget-item { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>💰 Monthly Expense Tracker</h1>
            <p id="header-subtitle">Track your expenses and share with your partner</p>
        </div>
        <div class="main-card">
            <div class="tabs">
                <button class="tab active" data-tab-name="add" onclick="switchTab(event, 'add')">Add Expense</button>
                <button class="tab" data-tab-name="view" onclick="switchTab(event, 'view')">View Expenses</button>
                <button class="tab" data-tab-name="summary" onclick="switchTab(event, 'summary')">Summary</button>
                <button class="tab" data-tab-name="budget" onclick="switchTab(event, 'budget')">Budget</button>
                <button class="tab" data-tab-name="categories" onclick="switchTab(event, 'categories')">Categories</button>
                <button class="tab" data-tab-name="owed" onclick="switchTab(event, 'owed')">Owed Money</button>
            </div>
            <div class="content">
                <div id="add-tab" class="tab-content active">
                    <form id="expense-form">
                        <div class="form-group"><label for="date">Date</label><input type="date" id="date" required></div>
                        <div class="form-group">
                            <label for="category">Category</label>
                            <select id="category" required><option value="">Select Category</option></select>
                        </div>
                        <div class="form-group"><label for="amount">Amount (MYR)</label><input type="number" id="amount" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group"><label for="description">Description</label><textarea id="description" rows="3" placeholder="Enter expense details..."></textarea></div>
                        
                        <div class="form-group">
                            <label>Paid By</label>
                            <div style="display: flex; gap: 20px; align-items: center;">
                                <label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="paidBy" value="Me" checked> Me</label>
                                <label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="paidBy" value="Wife"> Wife</label>
                            </div>
                        </div>

                        <div class="form-group" id="add-image-source-selector">
                            <label>Image Source (Optional)</label>
                            <div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px;">
                                <label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="image-source" value="upload" checked> Upload Image</label>
                                <label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="image-source" value="paste"> Paste Image</label>
                            </div>
                        </div>

                        <div class="form-group">
                            <div id="add-image-upload-container">
                                <div class="file-upload">
                                    <input type="file" id="pasted-image-upload" accept="image/*">
                                    <label for="pasted-image-upload" class="file-upload-label">
                                        <span>🎨 Click to Upload Image</span>
                                    </label>
                                </div>
                            </div>
                            <div id="add-image-paste-container" style="display: none;">
                                 <div class="file-upload">
                                    <div id="paste-image-box" class="file-upload-label" contenteditable="true"></div>
                                 </div>
                            </div>
                            <div class="progress-bar-container" id="add-image-progress-container"><div class="progress-bar" id="add-image-progress-bar"></div></div>
                            <input type="hidden" id="hidden-pasted-image-url">
                            <div id="pasted-image-preview-container" style="display:none; margin-top: 10px; text-align: center;"></div>
                        </div>

                        <div class="form-group">
                            <label for="receipt">Upload Receipt/Proof</label>
                            <input type="hidden" id="hidden-receipt-url">
                            <div class="file-upload">
                                <input type="file" id="receipt" accept="image/*,.pdf">
                                <label for="receipt" class="file-upload-label">
                                    <span id="file-label-text">📁 Click to upload receipt (optional)</span>
                                </label>
                            </div>
                            <div class="progress-bar-container" id="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                            <div id="receipt-preview-container" style="display:none;"></div>
                        </div>
                        <button type="submit" class="btn">Add Expense</button>
                    </form>
                </div>
                <div id="view-tab" class="tab-content">
                    <div class="filter-section">
                        <select id="filter-month" onchange="filterExpenses()"><option value="">All Months</option></select>
                        <select id="filter-category" onchange="filterExpenses()"><option value="">All Categories</option></select>
                        <select id="filter-paid-by" onchange="filterExpenses()">
                            <option value="">All Payers</option>
                            <option value="Me">Paid by Me</option>
                            <option value="Wife">Paid by Wife</option>
                        </select>
                        <select id="sort-expenses" onchange="filterExpenses()">
                            <option value="date-desc">Sort by Date (Newest)</option>
                            <option value="date-asc">Sort by Date (Oldest)</option>
                            <option value="amount-desc">Sort by Amount (High-Low)</option>
                            <option value="amount-asc">Sort by Amount (Low-High)</option>
                        </select>
                        <button class="btn export-btn" onclick="exportData()">📊 Export Data</button>
                    </div>
                    <div class="expenses-list" id="expenses-list"></div>
                </div>
                <div id="summary-tab" class="tab-content">
                    <h2 id="summary-month-header" style="text-align: center; margin-bottom: 25px; color: #2c3e50;"></h2>
                    <div class="summary-cards">
                        <div class="summary-card" title="Your salary for the current month."><h3>Your Salary</h3><div class="amount" id="month-salary">RM 0.00</div></div>
                        <div class="summary-card" title="Total expenses paid by you and your wife this month."><h3>Total Household Expenses</h3><div class="amount" id="month-amount">RM 0.00</div></div>
                        <div class="summary-card" title="Your Salary - Your Spending."><h3>Remaining from Salary</h3><div class="amount" id="remaining-balance">RM 0.00</div></div>
                        <div class="summary-card" title="Total of active debts owed to you."><h3>Money Owed to You</h3><div class="amount" id="owed-to-me">RM 0.00</div></div>
                        <div class="summary-card" title="Expenses paid only by you this month."><h3>Your Spending</h3><div class="amount" id="my-spending">RM 0.00</div></div>
                        <div class="summary-card" title="Expenses paid only by your wife this month."><h3>Wife's Spending</h3><div class="amount" id="wife-spending">RM 0.00</div></div>
                    </div>
                    <div id="salary-section" class="expenses-list" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Manage Your Salary</h3>
                        <form id="salary-form">
                            <div class="form-group"><label for="salary-month">Select Month</label><input type="text" id="salary-month" placeholder="Select a month..." required></div>
                            <div class="form-group"><label for="salary-amount">Salary Amount (MYR)</label><input type="number" id="salary-amount" step="0.01" placeholder="0.00" required></div>
                            <button type="submit" class="btn">Save Salary</button>
                        </form>
                    </div>
                </div>
                <div id="budget-tab" class="tab-content">
                    <div class="form-group"><label for="budget-month">Select month to view/edit budget</label><input type="text" id="budget-month" required></div>
                    <div class="summary-cards" style="margin-top:30px; margin-bottom: 30px;">
                        <div class="summary-card" title="The sum of all individual category budgets for the selected month."><h3>Total Budget</h3><div class="amount" id="budget-total-amount">RM 0.00</div></div>
                        <div class="summary-card" title="The sum of all expenses recorded in the selected month."><h3>Total Spent</h3><div class="amount" id="budget-spent-amount">RM 0.00</div></div>
                        <div class="summary-card" title="Calculation: Total Budget - Total Spent for the selected month."><h3>Overall Remaining</h3><div class="amount" id="budget-overall-remaining">RM 0.00</div></div>
                    </div>
                    <div class="expenses-list" id="budget-list"></div>
                </div>
                <div id="categories-tab" class="tab-content">
                    <form id="category-form">
                        <div class="form-group"><label for="category-name">Category Name</label><input type="text" id="category-name" placeholder="e.g., Groceries" required></div>
                        <div class="form-group"><label>Choose an Icon</label><div id="icon-preset-grid"></div><input type="hidden" id="selected-icon" required></div>
                        <button type="submit" class="btn">Add Category</button>
                    </form>
                    <div class="expenses-list" id="custom-categories-list" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Your Categories</h3>
                    </div>
                </div>
                <div id="owed-tab" class="tab-content">
                    <form id="owed-form">
                        <div class="form-group"><label for="owed-person">Who Owes You?</label><input type="text" id="owed-person" placeholder="e.g., Sibling's Name" required></div>
                        <div class="form-group"><label for="owed-amount">Amount (MYR)</label><input type="number" id="owed-amount" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group"><label for="owed-description">Description</label><textarea id="owed-description" rows="2" placeholder="e.g., Lunch, Cinema Tickets..."></textarea></div>
                        <button type="submit" class="btn">Add Owed Entry</button>
                    </form>
                    <div class="expenses-list" id="owed-list" style="margin-top: 30px;"></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="image-modal" class="modal-overlay" onclick="hideImageModal()"><div class="modal-content" style="padding: 10px; max-width: 90vw; max-height: 90vh; background: none; box-shadow: none;" onclick="event.stopPropagation()"><button class="modal-close-btn" onclick="hideImageModal()">&times;</button><img id="image-modal-img" src="" alt="Full-size Image" style="max-width: 100%; max-height: calc(90vh - 20px); display: block; margin: auto;"></div></div>
    <div id="edit-category-modal" class="modal-overlay"><div class="modal-content" style="padding:0;"><div class="modal-header"><h2>Edit Category</h2><button class="modal-close-btn" onclick="hideEditModal()">&times;</button></div><form id="edit-category-form"><div class="modal-body"><input type="hidden" id="edit-category-id"><div class="form-group"><label for="edit-category-name">Category Name</label><input type="text" id="edit-category-name" required></div><div class="form-group"><label>Choose an Icon</label><div id="edit-icon-preset-grid"></div><input type="hidden" id="edit-selected-icon" required></div></div><div class="modal-buttons"><button type="submit" class="btn">Save Changes</button><button type="button" class="btn" style="background: #6c757d;" onclick="hideEditModal()">Cancel</button></div></form></div></div>
    <div id="edit-expense-modal" class="modal-overlay"><div class="modal-content" style="padding:0;"><form id="edit-expense-form"><div class="modal-header"><h2>Edit Expense</h2><button type="button" class="modal-close-btn" onclick="hideEditExpenseModal()">&times;</button></div><div class="modal-body"><input type="hidden" id="edit-expense-id"><input type="hidden" id="hidden-edit-pasted-image-url"><div class="form-group"><label for="edit-date">Date</label><input type="date" id="edit-date" required></div><div class="form-group"><label for="edit-category">Category</label><select id="edit-category" required></select></div><div class="form-group"><label for="edit-amount">Amount (MYR)</label><input type="number" id="edit-amount" step="0.01" required></div><div class="form-group"><label for="edit-description">Description</label><textarea id="edit-description" rows="3"></textarea></div><div class="form-group"><label>Paid By</label><div style="display: flex; gap: 20px; align-items: center;"><label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="editPaidBy" value="Me"> Me</label><label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="editPaidBy" value="Wife"> Wife</label></div></div><div class="form-group" id="edit-image-source-selector"><label>Image Source (Optional)</label><div style="display: flex; gap: 20px; align-items: center; margin-bottom: 10px;"><label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="edit-image-source" value="upload" checked> Upload Image</label><label style="font-weight: normal; margin-bottom: 0;"><input type="radio" name="edit-image-source" value="paste"> Paste Image</label></div></div><div class="form-group"><div id="edit-image-upload-container"><div class="file-upload"><input type="file" id="edit-pasted-image-upload" accept="image/*"><label for="edit-pasted-image-upload" class="file-upload-label"><span>🎨 Click to Upload Image</span></label></div></div><div id="edit-image-paste-container" style="display: none;"><div class="file-upload"><div id="edit-paste-image-box" class="file-upload-label" contenteditable="true"></div></div></div><div class="progress-bar-container" id="edit-image-progress-container"><div class="progress-bar" id="edit-image-progress-bar"></div></div><div id="edit-pasted-image-preview-container" style="display:none; margin-top: 10px; text-align: center;"></div></div><div class="form-group"><label>Upload Receipt/Proof</label><div id="existing-receipt-container" style="display:none;"><a id="existing-receipt-link" href="#" target="_blank" rel="noopener noreferrer" class="receipt-link">View Current Receipt</a><button type="button" id="remove-receipt-btn" class="delete-btn">Remove Receipt</button></div><div class="file-upload"><input type="file" id="edit-receipt" accept="image/*,.pdf"><label for="edit-receipt" class="file-upload-label" id="edit-file-label"><span id="edit-file-label-default">📁 Click to upload a new receipt</span><span id="edit-file-label-selected" style="display: none;"></span></label></div><div class="progress-bar-container" id="edit-progress-container"><div class="progress-bar" id="edit-progress-bar"></div></div></div></div><div class="modal-buttons"><button type="submit" class="btn">Save Changes</button><button type="button" class="btn" style="background: #6c757d;" onclick="hideEditExpenseModal()">Cancel</button></div></form></div></div>
    <div id="edit-owed-modal" class="modal-overlay"><div class="modal-content" style="padding:0;"><div class="modal-header"><h2>Edit Owed Entry</h2><button class="modal-close-btn" onclick="hideEditOwedModal()">&times;</button></div><form id="edit-owed-form"><div class="modal-body"><input type="hidden" id="edit-owed-id"><div class="form-group"><label for="edit-owed-person">Who Owes You?</label><input type="text" id="edit-owed-person" required></div><div class="form-group"><label for="edit-owed-amount">Amount (MYR)</label><input type="number" id="edit-owed-amount" step="0.01" required></div><div class="form-group"><label for="edit-owed-description">Description</label><textarea id="edit-owed-description" rows="2"></textarea></div></div><div class="modal-buttons"><button type="submit" class="btn">Save Changes</button><button type="button" class="btn" style="background: #6c757d;" onclick="hideEditOwedModal()">Cancel</button></div></form></div></div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr@4.6.13/dist/plugins/monthSelect/index.js"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isViewOnlyMode = urlParams.get('view') === 'true';

        let allExpenses = [];
        let allCategories = [];
        let allSalaries = {};
        let allBudgets = {};
        let allOwedMoney = [];
        let isInitialExpenseLoad = true;
        let tempPastedImageUrl = null; 
        const presetIcons = [ '🏡', '💡', '💧', '🌐', '🛋️', '📺', '🚗', '⛽', '🛣️', '🅿️', '🔧', '📱', '🎬', '🎵', '🧸', '🍼', '🛒', '🧽', '💳', '📦', '🍴', '🛵', '🎮', '🎥', '⚽', '🎸', '🏥', '💊', '🏋️', '💰', '📈', '📶', '👨‍👩‍👦' ];

        async function setInDB(collectionName, docId, data) {
            if (isViewOnlyMode) return false;
            try {
                const docRef = fb.doc(db, collectionName, docId);
                await fb.setDoc(docRef, data, { merge: true });
                return true;
            } catch (error) {
                console.error(`Error setting document in ${collectionName}:`, error);
                alert(`Failed to save ${collectionName.slice(0, -1)}.`);
                return false;
            }
        }

        async function deleteFromDB(event, collectionName, id) {
            if (isViewOnlyMode) return;
            if (!confirm(`Are you sure you want to delete this ${collectionName.slice(0, -1)}?`)) return;

            const button = event.target;
            button.disabled = true;
            const originalText = button.textContent;
            button.textContent = 'Deleting...';
            const actionButtons = button.closest('.expense-actions') || button.closest('div');
            actionButtons.querySelectorAll('button').forEach(btn => btn.disabled = true);

            const docRef = fb.doc(db, collectionName, id);

            if (collectionName === 'expenses') {
                try {
                    const docSnap = await fb.getDoc(docRef);
                    if (docSnap.exists()) {
                        const expenseData = docSnap.data();
                        if (expenseData.receipt) await fb.deleteObject(fb.ref(storage, expenseData.receipt));
                        if (expenseData.pastedImage) await fb.deleteObject(fb.ref(storage, expenseData.pastedImage));
                    }
                } catch (error) {
                    console.error("Error deleting associated files from Storage:", error);
                }
            }

            try {
                await fb.deleteDoc(docRef);
            } catch (error) {
                console.error(`Error deleting document from ${collectionName}:`, error);
                button.textContent = originalText;
                 actionButtons.querySelectorAll('button').forEach(btn => btn.disabled = false);
            }
        }
        
        function listenForBudgets() {
            fb.onSnapshot(fb.collection(db, "budgets"), (snapshot) => {
                allBudgets = {};
                snapshot.docs.forEach(doc => { allBudgets[doc.id] = doc.data(); });
                displayBudgets();
                updateSummary();
            });
        }
        
        function listenForOwedMoney() {
            const q = fb.query(fb.collection(db, "owedMoney"), fb.orderBy("timestamp", "desc"));
            fb.onSnapshot(q, (snapshot) => {
                allOwedMoney = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                displayOwedMoney();
                updateSummary();
            });
        }

        function updateSalaryInputForMonth(monthStr) {
            const salaryAmountInput = document.getElementById('salary-amount');
            salaryAmountInput.value = (allSalaries && allSalaries[monthStr]) ? parseFloat(allSalaries[monthStr].amount).toFixed(2) : '';
        }

        function listenForSalaries() {
            fb.onSnapshot(fb.collection(db, "salaries"), (snapshot) => {
                allSalaries = {};
                snapshot.docs.forEach(doc => { allSalaries[doc.id] = doc.data(); });
                const currentSelectedMonth = document.getElementById('salary-month').value;
                if (currentSelectedMonth) updateSalaryInputForMonth(currentSelectedMonth);
                updateDisplay();
            });
        }
        function listenForCategories() {
            const q = fb.query(fb.collection(db, "categories"), fb.orderBy("name", "asc"));
            fb.onSnapshot(q, (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCategoryDropdown(); populateCategoryFilter(); displayCategories(); displayBudgets(); updateDisplay();
            });
        }
       function listenForExpenses() {
            const q = fb.query(fb.collection(db, "expenses"), fb.orderBy("date", "desc"));
            fb.onSnapshot(q, (snapshot) => {
                allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

                if (isInitialExpenseLoad) {
                    populateMonthFilter();
                    const select = document.getElementById('filter-month');
                    const now = new Date();
                    const currentMonthValue = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
                    
                    if (select.querySelector(`option[value="${currentMonthValue}"]`)) {
                        select.value = currentMonthValue;
                    }
                    isInitialExpenseLoad = false;
                }
                
                updateDisplay();
            });
        }

        document.getElementById('expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
            
            const receiptURL = document.getElementById('hidden-receipt-url').value || null;
            const pastedImageURL = document.getElementById('hidden-pasted-image-url').value || null;
            
            const expense = { 
                date: document.getElementById('date').value, 
                category: document.getElementById('category').value, 
                amount: parseFloat(document.getElementById('amount').value), 
                description: document.getElementById('description').value, 
                paidBy: document.querySelector('input[name="paidBy"]:checked').value,
                receipt: receiptURL, 
                pastedImage: pastedImageURL,
                timestamp: new Date().toISOString() 
            };

            const success = await fb.addDoc(fb.collection(db, "expenses"), expense);
            
            if (success) { 
                this.reset(); 
                clearFileInput(null, false);
                clearPastedImage(null, false, 'add');
                flatpickr("#date").setDate("today"); 
                alert('Expense added!'); 
                document.querySelectorAll('.tab[data-tab-name="view"]')[0].click(); 
            }
            
            submitBtn.disabled = false; 
            submitBtn.textContent = 'Add Expense';
        });
        
        document.getElementById('salary-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const monthYear = document.getElementById('salary-month').value;
            const amount = parseFloat(document.getElementById('salary-amount').value);
            if (!monthYear || isNaN(amount)) { return alert("Please select a month and enter a valid salary amount."); }
            if (await setInDB("salaries", monthYear, { amount })) {
                alert(`Salary for ${monthYear} saved!`);
            }
        });

        document.getElementById('category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('category-name').value;
            const icon = document.getElementById('selected-icon').value;
            if (!name || !icon) { return alert("Please enter a name and select an icon."); }
            if (await fb.addDoc(fb.collection(db, "categories"), { name, icon })) {
                 this.reset(); document.getElementById('selected-icon').value = ''; document.querySelector('#icon-preset-grid .icon-preset.selected')?.classList.remove('selected'); alert('Category added!');
            }
        });

        document.getElementById('owed-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const owedEntry = {
                person: document.getElementById('owed-person').value,
                amount: parseFloat(document.getElementById('owed-amount').value),
                description: document.getElementById('owed-description').value,
                date: new Date().toISOString().split('T')[0],
                status: 'Owed',
                timestamp: new Date().toISOString()
            };

            if (await fb.addDoc(fb.collection(db, "owedMoney"), owedEntry)) {
                this.reset();
                alert('Owed entry added!');
            }
        });

        document.getElementById('edit-category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isViewOnlyMode) return;
            const id = document.getElementById('edit-category-id').value;
            const updatedData = { name: document.getElementById('edit-category-name').value, icon: document.getElementById('edit-selected-icon').value };
            try { await fb.updateDoc(fb.doc(db, "categories", id), updatedData); alert("Category updated!"); hideEditModal(); } catch (error) { console.error("Error updating category:", error); alert("Failed to update category."); }
        });
        
         document.getElementById('edit-owed-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isViewOnlyMode) return;
            const id = document.getElementById('edit-owed-id').value;
            const updatedData = { 
                person: document.getElementById('edit-owed-person').value,
                amount: parseFloat(document.getElementById('edit-owed-amount').value),
                description: document.getElementById('edit-owed-description').value
            };
            try { 
                await fb.updateDoc(fb.doc(db, "owedMoney", id), updatedData); 
                alert("Owed entry updated!"); 
                hideEditOwedModal(); 
            } catch (error) { 
                console.error("Error updating owed entry:", error); 
                alert("Failed to update owed entry."); 
            }
        });
        
        async function clearFileInput(event, deleteFromStorage = true) {
            const button = event ? event.target : null;
            const hiddenUrlInput = document.getElementById('hidden-receipt-url');
            const fileUrl = hiddenUrlInput.value;

            if (deleteFromStorage && fileUrl) {
                if (!confirm("Are you sure you want to remove this receipt? It will be deleted permanently.")) return;
                if(button) {
                    button.disabled = true;
                    button.innerHTML = '&#8635;'; // Spinner
                }
                try {
                    await fb.deleteObject(fb.ref(storage, fileUrl));
                } catch (error) {
                    console.error("Error deleting file from Storage:", error);
                    alert("Could not delete the file. Please try again.");
                    if(button) {
                       button.disabled = false;
                       button.innerHTML = '&times;';
                    }
                    return;
                }
            }
            
            document.getElementById('receipt').value = '';
            hiddenUrlInput.value = '';
            document.getElementById('file-label-text').textContent = '📁 Click to upload receipt (optional)';
            const previewContainer = document.getElementById('receipt-preview-container');
            previewContainer.innerHTML = '';
            previewContainer.style.display = 'none';
        }
        
        async function clearPastedImage(event, deleteFromStorage = true, formType = 'add') {
            const hiddenInputId = (formType === 'add') ? 'hidden-pasted-image-url' : 'hidden-edit-pasted-image-url';
            const previewContainerId = (formType === 'add') ? 'pasted-image-preview-container' : 'edit-pasted-image-preview-container';
            
            if (deleteFromStorage) {
                if (!confirm("Are you sure you want to remove this pasted image?")) return;
                const button = event.target;
                button.disabled = true;
                button.innerHTML = '&#8635;'; // Spinner

                const hiddenUrlInput = document.getElementById(hiddenInputId);
                const fileUrl = hiddenUrlInput.value;
                if (fileUrl) {
                    try {
                        await fb.deleteObject(fb.ref(storage, fileUrl));
                    } catch (error) {
                        console.error("Error deleting pasted image from Storage:", error);
                        alert("Could not delete the pasted image. Please try again.");
                        button.disabled = false;
                        button.innerHTML = '&times;';
                        return;
                    }
                }
            }

            document.getElementById(hiddenInputId).value = '';
            const previewContainer = document.getElementById(previewContainerId);
            previewContainer.innerHTML = '';
            previewContainer.style.display = 'none';
            
            const sourceSelectorId = (formType === 'add') ? 'add-image-source-selector' : 'edit-image-source-selector';
            const uploadContainerId = (formType === 'add') ? 'add-image-upload-container' : 'edit-image-upload-container';
            const pasteContainerId = (formType === 'add') ? 'add-image-paste-container' : 'edit-image-paste-container';

            document.getElementById(sourceSelectorId).style.display = 'block';
            document.querySelector(`input[name="${formType === 'add' ? 'image-source' : 'edit-image-source'}"][value="upload"]`).checked = true;
            document.getElementById(uploadContainerId).style.display = 'block';
            document.getElementById(pasteContainerId).style.display = 'none';
        }


        function updateDisplay() {
            if(!isInitialExpenseLoad) {
                populateMonthFilter();
                filterExpenses();
            }
            updateSummary();
            displayCategories();
            displayBudgets();
            displayOwedMoney();
        }

        function displayExpenses(filtered = null) {
            const list = document.getElementById('expenses-list');
            const expensesToShow = filtered || allExpenses;
            if (expensesToShow.length === 0) {
                list.innerHTML = `<div class="no-expenses"><div class="no-expenses-icon">📭</div><p>No expenses found. Start tracking!</p></div>`;
                return;
            }
            list.innerHTML = expensesToShow.map(exp => {
                const category = allCategories.find(c => c.name === exp.category);
                const icon = category ? category.icon : '📌';
                
                let descriptionHTML = exp.description || '';
                if(exp.pastedImage) {
                    descriptionHTML += `<br><img src="${exp.pastedImage}" alt="Pasted content" onclick="showImageModal('${exp.pastedImage}')" />`;
                }
                
                const paidByTag = exp.paidBy ? `<span style="font-size: 12px; color: #8898aa; margin-left: 10px;">(Paid by: ${exp.paidBy})</span>` : '';

                const actionButtons = isViewOnlyMode ? '' : `
                    <div class="expense-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="padding: 8px 12px; font-size: 14px; background: #ffc107;" onclick="showEditExpenseModal('${exp.id}')">Edit</button>
                        <button class="delete-btn" style="margin-top: 0;" onclick="deleteFromDB(event, 'expenses', '${exp.id}')">Delete</button>
                    </div>`;
                return `
                <div class="expense-item">
                    <div class="expense-header">
                        <div><span class="expense-category">${icon} ${exp.category}</span></div>
                        <div class="expense-amount">RM ${exp.amount.toFixed(2)}${paidByTag}</div>
                    </div>
                    <div class="expense-details">${descriptionHTML}</div>
                    <div class="expense-date">📅 ${formatDate(exp.date)}</div>
                    ${exp.receipt ? `<a href="${exp.receipt}" target="_blank" rel="noopener noreferrer" class="receipt-link">View Receipt</a>` : ''}
                    ${actionButtons}
                </div>`;
            }).join('');
        }
        
        function displayOwedMoney() {
            const list = document.getElementById('owed-list');
            const owedToShow = allOwedMoney.filter(o => o.status === 'Owed');

            if (owedToShow.length === 0) {
                list.innerHTML = `<h3 style="margin-bottom: 20px; color: #2c3e50;">Currently Owed</h3><div class="no-expenses" style="padding: 20px;"><p>No outstanding debts.</p></div>`;
                return;
            }
            
            const actionButtons = (itemId) => isViewOnlyMode ? '' : `
                <button class="btn" style="padding: 8px 12px; font-size: 14px; background: #ffc107; margin-right: 10px;" onclick="showEditOwedModal('${itemId}')">Edit</button>
                <button class="delete-btn" style="margin-top: 0;" onclick="deleteFromDB(event, 'owedMoney', '${itemId}')">Delete</button>
            `;

            list.innerHTML = `<h3 style="margin-bottom: 20px; color: #2c3e50;">Currently Owed</h3>` + owedToShow.map(item => `
                <div class="expense-item">
                    <div class="expense-header">
                        <div>
                            <span class="expense-category" style="background: #ffc107; color: #212529;">${item.person}</span>
                            <div style="font-size: 14px; color: #657786; margin-top: 8px;">${item.description || 'No description'}</div>
                        </div>
                        <div class="expense-amount">RM ${item.amount.toFixed(2)}</div>
                    </div>
                    <div class="expense-date">Recorded: ${formatDate(item.date)}</div>
                    <div style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="padding: 8px 12px; font-size: 14px; background: #28a745;" onclick="markOwedAsPaid(event, '${item.id}')">Mark as Paid</button>
                        ${actionButtons(item.id)}
                    </div>
                </div>
            `).join('');
        }

        async function markOwedAsPaid(event, id) {
            if (isViewOnlyMode) return;
            const button = event.target;
            button.disabled = true;
            button.textContent = 'Updating...';
            try {
                await fb.updateDoc(fb.doc(db, "owedMoney", id), { status: 'Paid' });
            } catch (error) {
                console.error("Error updating owed status:", error);
                alert("Failed to update status.");
                button.disabled = false;
                button.textContent = 'Mark as Paid';
            }
        }


        function displayCategories() {
            const list = document.getElementById('custom-categories-list');
            list.innerHTML = '<h3 style="margin-bottom: 20px; color: #2c3e50;">Your Categories</h3>';
            if (allCategories.length === 0) { list.innerHTML += `<p style="text-align: center; color: #8898aa;">No categories yet.</p>`; return; }
            list.innerHTML += allCategories.map(cat => {
                const actionButtons = isViewOnlyMode ? '' : `
                    <button class="btn" style="padding: 8px 16px; margin-top: 0; background: #ffc107;" onclick="showEditModal('${cat.id}', '${cat.name}', '${cat.icon}')">Edit</button>
                    <button class="delete-btn" style="margin-top: 0;" onclick="deleteFromDB(event, 'categories', '${cat.id}')">Delete</button>`;
                return `
                <div class="expense-item custom-category-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div><span style="font-size: 24px; margin-right: 15px;">${cat.icon}</span><span style="font-weight: 600;">${cat.name}</span></div>
                    <div class="category-actions">${actionButtons}</div>
                </div>`;
            }).join('');
        }

        function updateSummary() {
            const now = new Date();
            const currentMonthStr = `${now.getFullYear()}-${(now.getMonth() + 1).toString().padStart(2, '0')}`;
            const monthExpenses = allExpenses.filter(exp => exp.date.startsWith(currentMonthStr));
            
            const totalMonthExpenses = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            const mySpending = monthExpenses.filter(e => e.paidBy === 'Me').reduce((sum, exp) => sum + exp.amount, 0);
            const wifeSpending = monthExpenses.filter(e => e.paidBy === 'Wife').reduce((sum, exp) => sum + exp.amount, 0);
            
            const currentMonthSalary = allSalaries[currentMonthStr] ? allSalaries[currentMonthStr].amount : 0;
            const remainingFromSalary = currentMonthSalary - mySpending;
            
            const totalOwed = allOwedMoney.filter(o => o.status === 'Owed').reduce((sum, item) => sum + item.amount, 0);

            document.getElementById('month-amount').textContent = `RM ${totalMonthExpenses.toFixed(2)}`;
            document.getElementById('my-spending').textContent = `RM ${mySpending.toFixed(2)}`;
            document.getElementById('wife-spending').textContent = `RM ${wifeSpending.toFixed(2)}`;
            document.getElementById('month-salary').textContent = `RM ${currentMonthSalary.toFixed(2)}`;
            document.getElementById('remaining-balance').textContent = `RM ${remainingFromSalary.toFixed(2)}`;
            document.getElementById('owed-to-me').textContent = `RM ${totalOwed.toFixed(2)}`;
            
            const summaryHeader = document.getElementById('summary-month-header');
            summaryHeader.textContent = `Summary for ${now.toLocaleString('default', { month: 'long' })} ${now.getFullYear()}`;
        }
        
        function displayBudgets() {
            const month = document.getElementById('budget-month').value;
            const list = document.getElementById('budget-list');
            const totalBudgetEl = document.getElementById('budget-total-amount');
            const totalSpentEl = document.getElementById('budget-spent-amount');
            const overallRemainingEl = document.getElementById('budget-overall-remaining');
            if (!month) {
                list.innerHTML = `<p style="text-align: center; color: #8898aa;">Please select a month to manage budgets.</p>`;
                totalBudgetEl.textContent = 'RM 0.00';
                totalSpentEl.textContent = 'RM 0.00';
                overallRemainingEl.textContent = 'RM 0.00';
                return;
            }
            const expensesForMonth = allExpenses.filter(e => e.date.startsWith(month));
            const budgetsForMonth = allBudgets[month] || {};
            const totalBudgetForMonth = Object.values(budgetsForMonth).reduce((sum, val) => sum + val, 0);
            const totalSpentForMonth = expensesForMonth.reduce((sum, exp) => sum + exp.amount, 0);
            const overallRemaining = totalBudgetForMonth - totalSpentForMonth;
            totalBudgetEl.textContent = `RM ${totalBudgetForMonth.toFixed(2)}`;
            totalSpentEl.textContent = `RM ${totalSpentForMonth.toFixed(2)}`;
            overallRemainingEl.textContent = `RM ${overallRemaining.toFixed(2)}`;
            if (allCategories.length === 0) {
                list.innerHTML = `<p style="text-align: center; color: #8898aa;">Please add some categories first.</p>`;
                return;
            }
            list.innerHTML = allCategories.map(cat => {
                const budgetAmount = budgetsForMonth[cat.name] || 0;
                const spentAmount = expensesForMonth.filter(e => e.category === cat.name).reduce((sum, e) => sum + e.amount, 0);
                const remaining = budgetAmount - spentAmount;
                const progress = budgetAmount > 0 ? (spentAmount / budgetAmount) * 100 : (spentAmount > 0 ? 101 : 0);
                return `
                <div class="expense-item">
                    <div class="budget-item">
                        <div>
                            <span style="font-size: 24px; margin-right: 15px;">${cat.icon}</span>
                            <span style="font-weight: 600;">${cat.name}</span>
                        </div>
                        <div class="budget-input-group">
                             <input type="number" step="1" min="0" placeholder="0.00" class="budget-input" data-category="${cat.name}" value="${budgetAmount > 0 ? budgetAmount.toFixed(2) : ''}">
                             <button class="btn btn-small" onclick="saveBudget('${cat.name}')">Save</button>
                        </div>
                        <div class="budget-item-details">
                            <div class="budget-progress-bar-container">
                                <div class="budget-progress-bar ${progress > 100 ? 'over' : 'normal'}" style="width: ${Math.min(progress, 100)}%;"></div>
                            </div>
                            <div class="budget-info">
                                <span>Spent: RM ${spentAmount.toFixed(2)} of RM ${budgetAmount.toFixed(2)}</span>
                                <span class="budget-remaining ${remaining < 0 ? 'negative' : ''}">Remaining: RM ${remaining.toFixed(2)}</span>
                            </div>
                        </div>
                    </div>
                </div>`;
            }).join('');
             document.querySelectorAll('.budget-input').forEach(input => {
                input.addEventListener('keydown', function(event) {
                    if (event.key === 'Enter') {
                        event.preventDefault();
                        const categoryName = this.dataset.category;
                        saveBudget(categoryName);
                        this.blur();
                    }
                });
            });
        }
        
        async function saveBudget(categoryName) {
            if(isViewOnlyMode) return;
            const month = document.getElementById('budget-month').value;
            const input = document.querySelector(`.budget-input[data-category="${categoryName}"]`);
            const amount = parseFloat(input.value) || 0;
            
            const budgetData = allBudgets[month] || {};
            budgetData[categoryName] = amount;
            
            if (await setInDB("budgets", month, budgetData)) {
                alert(`Budget for ${categoryName} in ${month} saved!`);
            }
        }


        function populateIconGrid(gridId, hiddenInputId, selectedIcon = null) {
            const grid = document.getElementById(gridId); grid.innerHTML = '';
            presetIcons.forEach(icon => {
                const el = document.createElement('div'); el.className = 'icon-preset'; el.textContent = icon;
                if (icon === selectedIcon) el.classList.add('selected');
                el.addEventListener('click', () => {
                    grid.querySelector('.selected')?.classList.remove('selected');
                    el.classList.add('selected'); document.getElementById(hiddenInputId).value = icon;
                });
                grid.appendChild(el);
            });
        }
        function populateCategoryDropdown() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select Category</option>' + allCategories.map(c => `<option value="${c.name}">${c.icon} ${c.name}</option>`).join('');
        }
        function populateCategoryFilter() {
            const select = document.getElementById('filter-category');
            select.innerHTML = '<option value="">All Categories</option>' + allCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }
        function populateMonthFilter() {
            const select = document.getElementById('filter-month');
            const currentVal = select.value;
            const months = [...new Set(allExpenses.map(exp => exp.date.substring(0, 7)))].sort().reverse();
            select.innerHTML = '<option value="">All Months</option>' + months.map(m => {
                const [y, n] = m.split('-'); const d = new Date(y, n - 1);
                return `<option value="${m}">${d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</option>`;
            }).join('');
            if (select.querySelector(`option[value="${currentVal}"]`)) {
                select.value = currentVal;
            }
        }

        function filterExpenses() {
            const month = document.getElementById('filter-month').value; 
            const category = document.getElementById('filter-category').value;
            const paidBy = document.getElementById('filter-paid-by').value;
            const sortMethod = document.getElementById('sort-expenses').value;

            let filtered = [...allExpenses];
            if (month) filtered = filtered.filter(e => e.date.startsWith(month));
            if (category) filtered = filtered.filter(e => e.category === category);
            if (paidBy) filtered = filtered.filter(e => e.paidBy === paidBy);
            
            switch(sortMethod) {
                case 'date-asc': filtered.sort((a,b) => new Date(a.date) - new Date(b.date)); break;
                case 'amount-desc': filtered.sort((a,b) => b.amount - a.amount); break;
                case 'amount-asc': filtered.sort((a,b) => a.amount - b.amount); break;
                case 'date-desc': default: filtered.sort((a,b) => new Date(b.date) - new Date(a.date)); break;
            }

            displayExpenses(filtered);
        }
        function switchTab(e, name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${name}-tab`).classList.add('active');
            updateDisplay();
        }
        function formatDate(dateStr) { const d = new Date(dateStr); return d.toLocaleDateString('en-MY', { timeZone: 'UTC', year: 'numeric', month: 'long', day: 'numeric' }); }
        function exportData() {
            if (isViewOnlyMode) return;
            const dataStr = JSON.stringify({ expenses: allExpenses, categories: allCategories, salaries: allSalaries, budgets: allBudgets, owedMoney: allOwedMoney }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `expenses_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
        }
        function showEditModal(id, name, icon) {
            if (isViewOnlyMode) return;
            document.getElementById('edit-category-id').value = id; document.getElementById('edit-category-name').value = name;
            document.getElementById('edit-selected-icon').value = icon;
            populateIconGrid('edit-icon-preset-grid', 'edit-selected-icon', icon);
            document.getElementById('edit-category-modal').style.display = 'flex';
        }
        function hideEditModal() { document.getElementById('edit-category-modal').style.display = 'none'; }
        
        function showEditOwedModal(id) {
            if (isViewOnlyMode) return;
            const entry = allOwedMoney.find(o => o.id === id);
            if (!entry) return;
            document.getElementById('edit-owed-id').value = entry.id;
            document.getElementById('edit-owed-person').value = entry.person;
            document.getElementById('edit-owed-amount').value = entry.amount;
            document.getElementById('edit-owed-description').value = entry.description;
            document.getElementById('edit-owed-modal').style.display = 'flex';
        }
        function hideEditOwedModal() { document.getElementById('edit-owed-modal').style.display = 'none'; }
        
        function showImageModal(imageUrl) {
            document.getElementById('image-modal-img').src = imageUrl;
            document.getElementById('image-modal').style.display = 'flex';
        }

        function hideImageModal() {
            document.getElementById('image-modal').style.display = 'none';
        }
        
        async function showEditExpenseModal(expenseId) {
            if (isViewOnlyMode) return;
            tempPastedImageUrl = null;
            const expense = allExpenses.find(exp => exp.id === expenseId);
            if (!expense) { alert("Expense not found!"); return; }

            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-amount').value = expense.amount;
            document.getElementById('edit-description').value = expense.description;
            document.querySelector(`input[name="editPaidBy"][value="${expense.paidBy || 'Me'}"]`).checked = true;
            document.getElementById('hidden-edit-pasted-image-url').value = expense.pastedImage || '';

            if (expense.pastedImage) {
                const previewContainer = document.getElementById('edit-pasted-image-preview-container');
                previewContainer.innerHTML = `<img src="${expense.pastedImage}" alt="Pasted preview" style="max-width: 100%; max-height: 150px; border-radius: 5px;">
                                              <button type="button" onclick="clearPastedImage(event, true, 'edit')" class="remove-file-btn" style="display:inline-block; margin-left: 10px;">&times;</button>`;
                previewContainer.style.display = 'block';
                document.getElementById('edit-image-source-selector').style.display = 'none';
                document.getElementById('edit-image-upload-container').style.display = 'none';
                document.getElementById('edit-image-paste-container').style.display = 'none';
            } else {
                clearPastedImage(null, false, 'edit');
            }

            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = allCategories.map(c => `<option value="${c.name}" ${expense.category === c.name ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('');
            const existingReceiptContainer = document.getElementById('existing-receipt-container');
            if (expense.receipt) {
                document.getElementById('existing-receipt-link').href = expense.receipt;
                existingReceiptContainer.style.display = 'block';
            } else { existingReceiptContainer.style.display = 'none'; }
            
            document.getElementById('edit-receipt').value = '';
            document.getElementById('edit-file-label-default').style.display = 'inline';
            document.getElementById('edit-file-label-selected').style.display = 'none';
            document.getElementById('edit-expense-modal').style.display = 'flex';
            flatpickr("#edit-date", { dateFormat: "Y-m-d" });
        }

        function hideEditExpenseModal() { 
            if (tempPastedImageUrl) {
                fb.deleteObject(fb.ref(storage, tempPastedImageUrl)).catch(error => {
                    console.error("Failed to delete temporary uploaded file on cancel:", error);
                });
                tempPastedImageUrl = null;
            }
            document.getElementById('edit-expense-modal').style.display = 'none';
        }

        function setupViewOnlyUI() {
            if (!isViewOnlyMode) return;
            document.getElementById('header-subtitle').textContent = "View-Only Access";
            document.querySelector('.tab[data-tab-name="add"]').style.display = 'none';
            document.querySelector('.tab[data-tab-name="categories"]').style.display = 'none';
            document.querySelector('.tab[data-tab-name="budget"]').style.display = 'none';
             document.querySelector('.tab[data-tab-name="owed"]').style.display = 'none';
            document.getElementById('salary-section').style.display = 'none';
            document.querySelector('.export-btn').style.display = 'none';
            document.querySelectorAll('.tab[data-tab-name="view"]')[0].click();
        }

        document.getElementById('edit-expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isViewOnlyMode) return;

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const expenseId = document.getElementById('edit-expense-id').value;
            const originalExpense = allExpenses.find(exp => exp.id === expenseId);
            
            let newReceiptURL = originalExpense.receipt;
            let receiptUrlToDelete = null;

            const fileInput = document.getElementById('edit-receipt');
            
            try {
                if (fileInput.files[0]) {
                    if (originalExpense.receipt) {
                        receiptUrlToDelete = originalExpense.receipt;
                    }
                    const file = fileInput.files[0];
                    const storageRef = fb.ref(storage, `receipts/${Date.now()}_${file.name}`);
                    const uploadTask = fb.uploadBytesResumable(storageRef, file);
                    const progressContainer = document.getElementById('edit-progress-container');
                    const progressBar = document.getElementById('edit-progress-bar');
                    progressContainer.style.display = 'block';

                    newReceiptURL = await new Promise((resolve, reject) => {
                        uploadTask.on('state_changed', 
                            (snapshot) => { progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`; }, 
                            (error) => { console.error("Upload failed:", error); reject(error); }, 
                            async () => { const url = await fb.getDownloadURL(uploadTask.snapshot.ref); resolve(url); }
                        );
                    });
                }
                
                const updatedData = { 
                    date: document.getElementById('edit-date').value, 
                    category: document.getElementById('edit-category').value, 
                    amount: parseFloat(document.getElementById('edit-amount').value), 
                    description: document.getElementById('edit-description').value, 
                    paidBy: document.querySelector('input[name="editPaidBy"]:checked').value,
                    receipt: newReceiptURL,
                    pastedImage: document.getElementById('hidden-edit-pasted-image-url').value || null
                };

                await fb.updateDoc(fb.doc(db, "expenses", expenseId), updatedData);
                
                if (receiptUrlToDelete) {
                    await fb.deleteObject(fb.ref(storage, receiptUrlToDelete));
                }

                if (originalExpense.pastedImage && originalExpense.pastedImage !== updatedData.pastedImage) {
                     await fb.deleteObject(fb.ref(storage, originalExpense.pastedImage));
                }

                tempPastedImageUrl = null;
                alert("Expense updated successfully!");
                hideEditExpenseModal();

            } catch (error) {
                console.error("Error updating expense:", error);
                alert("Failed to update expense.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
                const progressContainer = document.getElementById('edit-progress-container');
                if(progressContainer) { 
                    progressContainer.style.display = 'none';
                    document.getElementById('edit-progress-bar').style.width = '0%'; 
                }
            }
        });


        document.getElementById('edit-receipt').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('edit-file-label-default').style.display = 'none';
                document.getElementById('edit-file-label-selected').textContent = file.name.length > 30 ? `${file.name.substring(0, 27)}...` : file.name;
                document.getElementById('edit-file-label-selected').style.display = 'inline';
            } else {
                document.getElementById('edit-file-label-default').style.display = 'inline';
                document.getElementById('edit-file-label-selected').style.display = 'none';
            }
        });

        document.getElementById('remove-receipt-btn').addEventListener('click', async function() {
            if (isViewOnlyMode) return;
            const expenseId = document.getElementById('edit-expense-id').value;
            if (!expenseId) return;
            if (confirm("Are you sure you want to remove the receipt? This cannot be undone.")) {
                const originalExpense = allExpenses.find(exp => exp.id === expenseId);
                const button = this;
                if (originalExpense && originalExpense.receipt) {
                    button.disabled = true;
                    const originalText = button.textContent;
                    button.textContent = 'Removing...';
                    try {
                        await fb.deleteObject(fb.ref(storage, originalExpense.receipt));
                        await fb.updateDoc(fb.doc(db, "expenses", expenseId), { receipt: null });
                        alert("Receipt removed."); document.getElementById('existing-receipt-container').style.display = 'none';
                    } catch (error) { console.error("Error removing receipt:", error); alert("Failed to remove receipt."); 
                    } finally {
                        button.disabled = false;
                        button.textContent = originalText;
                    }
                }
            }
        });
        
        async function handleImageUpload(file, formType) {
            const hiddenInputId = (formType === 'add') ? 'hidden-pasted-image-url' : 'hidden-edit-pasted-image-url';
            const previewContainerId = (formType === 'add') ? 'pasted-image-preview-container' : 'edit-pasted-image-preview-container';
            const progressContainerId = (formType === 'add') ? 'add-image-progress-container' : 'edit-image-progress-container';
            const progressBarId = (formType === 'add') ? 'add-image-progress-bar' : 'edit-image-progress-bar';
            
            const hiddenInput = document.getElementById(hiddenInputId);
            const previewContainer = document.getElementById(previewContainerId);
            const progressContainer = document.getElementById(progressContainerId);
            const progressBar = document.getElementById(progressBarId);

            const uploadContainerId = (formType === 'add') ? 'add-image-upload-container' : 'edit-image-upload-container';
            const pasteContainerId = (formType === 'add') ? 'add-image-paste-container' : 'edit-image-paste-container';
            const sourceSelectorId = (formType === 'add') ? 'add-image-source-selector' : 'edit-image-source-selector';
            
            document.getElementById(sourceSelectorId).style.display = 'none';
            document.getElementById(uploadContainerId).style.display = 'none';
            document.getElementById(pasteContainerId).style.display = 'none';
            
            progressContainer.style.display = 'block';
            progressBar.style.width = '0%';
            
            try {
                const storageRef = fb.ref(storage, `pasted_images/${Date.now()}_${file.name}`);
                const uploadTask = fb.uploadBytesResumable(storageRef, file);
                const downloadURL = await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', 
                        (snapshot) => { progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`; },
                        (error) => reject(error), 
                        async () => { const url = await fb.getDownloadURL(uploadTask.snapshot.ref); resolve(url); }
                    );
                });
                
                hiddenInput.value = downloadURL;
                if (formType === 'edit') tempPastedImageUrl = downloadURL;

                previewContainer.innerHTML = `<img src="${downloadURL}" alt="Pasted preview" style="max-width: 100%; max-height: 150px; border-radius: 5px;">
                                              <button type="button" onclick="clearPastedImage(event, true, '${formType}')" class="remove-file-btn" style="display:inline-block; margin-left: 10px;">&times;</button>`;
                previewContainer.style.display = 'block';

            } catch (error) {
                console.error("Image upload failed:", error);
                alert("Failed to upload image. Please try again.");
                document.getElementById(sourceSelectorId).style.display = 'block';
                document.getElementById(uploadContainerId).style.display = 'block';
            } finally {
                progressContainer.style.display = 'none';
                progressBar.style.width = '0%';
            }
        }

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr("#date", { dateFormat: "Y-m-d", defaultDate: "today" });
            const monthPickerConfig = {
                plugins: [ new monthSelectPlugin({ shorthand: true, dateFormat: "Y-m", altFormat: "F Y" }) ],
                defaultDate: new Date()
            };
            flatpickr("#salary-month", { ...monthPickerConfig, onChange: (selectedDates, dateStr) => updateSalaryInputForMonth(dateStr) });
            flatpickr("#budget-month", { ...monthPickerConfig, onChange: () => displayBudgets() });
            
            document.getElementById('receipt').addEventListener('change', async function() {
                if (this.files.length === 0) return;
                const file = this.files[0];
                const hiddenUrlInput = document.getElementById('hidden-receipt-url');
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                const previewContainer = document.getElementById('receipt-preview-container');
                const fileLabel = document.getElementById('file-label-text');

                progressContainer.style.display = 'block';
                progressBar.style.width = '0%';
                fileLabel.textContent = `Uploading ${file.name}...`;

                const storageRef = fb.ref(storage, `receipts/${Date.now()}_${file.name}`);
                const uploadTask = fb.uploadBytesResumable(storageRef, file);

                uploadTask.on('state_changed', 
                    (snapshot) => {
                        progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`;
                    }, 
                    (error) => {
                        console.error("Upload failed:", error);
                        alert("File upload failed. Please try again.");
                        clearFileInput(null, false);
                    }, 
                    async () => {
                        const downloadURL = await fb.getDownloadURL(uploadTask.snapshot.ref);
                        hiddenUrlInput.value = downloadURL;
                        progressContainer.style.display = 'none';
                        fileLabel.textContent = file.name;
                        
                        let previewContent = '';
                        if (file.type.startsWith('image/')) {
                            previewContent = `<img src="${downloadURL}" alt="Receipt preview">`;
                        } else {
                            previewContent = `<a href="${downloadURL}" target="_blank" class="receipt-link" style="margin-top: 0;">View Uploaded File</a>`;
                        }
                        previewContent += `<button type="button" onclick="clearFileInput(event, true)" class="remove-file-btn" style="display:inline-block; margin-left: 10px;">&times;</button>`;
                        
                        previewContainer.innerHTML = previewContent;
                        previewContainer.style.display = 'block';
                    }
                );
            });
            
            document.querySelectorAll('input[name="image-source"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isUpload = this.value === 'upload';
                    document.getElementById('add-image-upload-container').style.display = isUpload ? 'block' : 'none';
                    document.getElementById('add-image-paste-container').style.display = isUpload ? 'none' : 'block';
                });
            });
            
            document.querySelectorAll('input[name="edit-image-source"]').forEach(radio => {
                radio.addEventListener('change', function() {
                    const isUpload = this.value === 'upload';
                    document.getElementById('edit-image-upload-container').style.display = isUpload ? 'block' : 'none';
                    document.getElementById('edit-image-paste-container').style.display = isUpload ? 'none' : 'block';
                });
            });

            document.getElementById('paste-image-box').addEventListener('paste', (e) => {
                const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        handleImageUpload(item.getAsFile(), 'add');
                        return;
                    }
                }
            });
            
            document.getElementById('pasted-image-upload').addEventListener('change', function(e) {
                if(this.files && this.files[0]){
                    handleImageUpload(this.files[0], 'add');
                }
            });
            
            document.getElementById('edit-paste-image-box').addEventListener('paste', (e) => {
                 const items = (e.clipboardData || window.clipboardData).items;
                for (const item of items) {
                    if (item.type.startsWith('image/')) {
                        e.preventDefault();
                        handleImageUpload(item.getAsFile(), 'edit');
                        return;
                    }
                }
            });

            document.getElementById('edit-pasted-image-upload').addEventListener('change', function(e) {
                if(this.files && this.files[0]){
                    handleImageUpload(this.files[0], 'edit');
                }
            });


            populateIconGrid('icon-preset-grid', 'selected-icon');
            listenForSalaries();
            listenForCategories();
            listenForExpenses();
            listenForBudgets();
            listenForOwedMoney();
            setupViewOnlyUI();
        });
    </script>
</body>
</html>
