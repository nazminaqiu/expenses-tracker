<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Shared Monthly Expense Tracker</title>
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getFirestore, collection, addDoc, onSnapshot, doc, getDoc, deleteDoc, updateDoc, query, orderBy, setDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        import { getStorage, ref, uploadBytesResumable, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";

        // ==================================================================================
        // ====> ACTION: PASTE YOUR FIREBASE CONFIGURATION OBJECT FROM THE FIREBASE CONSOLE HERE
        // ==================================================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAgEXmz8rUKAUFFukKgKKromV03okUmfFQ",
            authDomain: "expenses-tracker-8725f.firebaseapp.com",
            projectId: "expenses-tracker-8725f",
            storageBucket: "expenses-tracker-8725f.firebasestorage.app",
            messagingSenderId: "717743221463",
            appId: "1:717743221463:web:d574feaf383b06a380de92",
            measurementId: "G-VN0F315CZF"
        };
        // ==================================================================================

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const storage = getStorage(app);

        window.db = db;
        window.storage = storage;
        window.fb = { collection, addDoc, onSnapshot, doc, getDoc, deleteDoc, updateDoc, query, orderBy, ref, uploadBytesResumable, getDownloadURL, deleteObject, setDoc };
    </script>

    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1200px; margin: 0 auto; }
        .header { text-align: center; color: white; margin-bottom: 30px; animation: fadeInDown 0.5s ease; }
        .header h1 { font-size: 2.5em; margin-bottom: 10px; text-shadow: 2px 2px 4px rgba(0,0,0,0.2); }
        .header p { font-size: 1.1em; opacity: 0.9; }
        .main-card { background: white; border-radius: 20px; box-shadow: 0 20px 60px rgba(0,0,0,0.3); overflow: hidden; animation: fadeInUp 0.5s ease; }
        .tabs { display: flex; background: #f7f9fc; border-bottom: 1px solid #e1e8ed; }
        .tab { flex: 1; padding: 20px; text-align: center; cursor: pointer; background: none; border: none; font-size: 16px; font-weight: 600; color: #657786; transition: all 0.3s ease; position: relative; }
        .tab:hover { background: rgba(102, 126, 234, 0.05); }
        .tab.active { color: #667eea; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; right: 0; height: 3px; background: linear-gradient(90deg, #667eea, #764ba2); animation: slideIn 0.3s ease; }
        @keyframes slideIn { from { width: 0; left: 50%; } to { width: 100%; left: 0; } }
        .content { padding: 30px; }
        .tab-content { display: none; animation: fadeIn 0.3s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #2c3e50; }
        input, select, textarea { width: 100%; padding: 12px; border: 2px solid #e1e8ed; border-radius: 10px; font-size: 15px; transition: all 0.3s ease; background-color: white; }
        input:focus, select:focus, textarea:focus { outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1); }
        .file-upload { position: relative; display: flex; align-items: center; }
        .file-upload input[type=file] { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }
        .file-upload-label { display: block; flex-grow: 1; padding: 12px; border: 2px dashed #667eea; border-radius: 10px; text-align: center; color: #667eea; font-weight: 600; transition: all 0.3s ease; }
        .file-upload:hover .file-upload-label { background: rgba(102, 126, 234, 0.05); border-color: #764ba2; }
        #file-label-selected { color: #2c3e50; font-weight: normal; font-style: italic; }
        .remove-file-btn { background: #e74c3c; color: white; border: none; border-radius: 50%; width: 28px; height: 28px; font-size: 18px; line-height: 28px; cursor: pointer; margin-left: -40px; z-index: 2; transition: all 0.2s ease; }
        .remove-file-btn:hover { background: #c0392b; transform: scale(1.1); }
        .btn { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 14px 30px; border: none; border-radius: 10px; font-size: 16px; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4); }
        .btn:active { transform: translateY(0); }
        .btn:disabled { background: #b0bec5; cursor: not-allowed; }
        .summary-cards { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 30px; }
        .summary-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); padding: 25px; border-radius: 15px; color: white; box-shadow: 0 10px 30px rgba(0,0,0,0.2); transform: translateY(0); transition: all 0.3s ease; }
        .summary-card:hover { transform: translateY(-5px); box-shadow: 0 15px 40px rgba(0,0,0,0.3); }
        .summary-card h3 { font-size: 14px; opacity: 0.9; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1px; }
        .summary-card .amount { font-size: 32px; font-weight: 700; }
        .expenses-list { background: #f7f9fc; border-radius: 15px; padding: 20px; }
        .expense-item { background: white; padding: 20px; border-radius: 10px; margin-bottom: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); transition: all 0.3s ease; animation: slideInLeft 0.4s ease; }
        @keyframes slideInLeft { from { opacity: 0; transform: translateX(-20px); } to { opacity: 1; transform: translateX(0); } }
        .expense-item:hover { box-shadow: 0 5px 20px rgba(0,0,0,0.1); transform: translateX(5px); }
        .expense-header { display: flex; justify-content: space-between; align-items: start; margin-bottom: 10px; }
        .expense-category { display: inline-block; padding: 5px 12px; border-radius: 20px; font-size: 13px; font-weight: 600; text-transform: capitalize; letter-spacing: 0.5px; background: #dfe6e9; color: #2d3436; }
        .expense-amount { font-size: 24px; font-weight: 700; color: #2c3e50; }
        .expense-details { color: #657786; font-size: 14px; line-height: 1.6; }
        .expense-date { color: #8898aa; font-size: 13px; margin-top: 10px; }
        .receipt-link { color: #667eea; text-decoration: none; font-size: 14px; font-weight: 600; display: inline-flex; align-items: center; margin-top: 10px; transition: color 0.3s ease; }
        .receipt-link:hover { color: #764ba2; }
        .receipt-link::before { content: "üìé"; margin-right: 5px; }
        .delete-btn { background: #e74c3c; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer; font-size: 14px; transition: all 0.3s ease; margin-top: 10px; }
        .delete-btn:hover { background: #c0392b; transform: scale(1.05); }
        .filter-section { display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .filter-section select { flex: 1; min-width: 150px; }
        .no-expenses { text-align: center; padding: 60px 20px; color: #8898aa; }
        .no-expenses-icon { font-size: 48px; margin-bottom: 20px; opacity: 0.5; }
        .export-btn { background: linear-gradient(135deg, #00b894, #00cec9); margin-left: 10px; }
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0, 0, 0, 0.6); display: none; align-items: center; justify-content: center; z-index: 1000; }
        .modal-content { background: white; padding: 30px; border-radius: 20px; width: 90%; max-width: 500px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); animation: fadeIn 0.3s ease; }
        .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; color: #2c3e50; }
        .modal-close-btn { background: none; border: none; font-size: 24px; cursor: pointer; color: #8898aa; }
        .modal-buttons { display: flex; gap: 10px; margin-top: 20px; }
        .progress-bar-container { width: 100%; height: 10px; background-color: #e1e8ed; border-radius: 5px; overflow: hidden; margin-top: 10px; display: none; }
        .progress-bar { width: 0%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2); transition: width 0.3s ease; }
        #icon-preset-grid, #edit-icon-preset-grid { display: flex; flex-wrap: wrap; gap: 10px; margin-top: 10px; }
        .icon-preset { font-size: 24px; padding: 10px; border: 2px solid #e1e8ed; border-radius: 10px; cursor: pointer; transition: all 0.2s ease; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; }
        .icon-preset:hover { transform: scale(1.1); border-color: #a29bfe; }
        .icon-preset.selected { border-color: #667eea; background-color: rgba(102, 126, 234, 0.1); transform: scale(1.1); }
        #existing-receipt-container { margin-bottom: 10px; }
        
        .category-breakdown-item { display: flex; justify-content: space-between; align-items: center; }
        .category-actions { display: flex; gap: 10px; align-items: center; }
        
        @media (max-width: 768px) {
            .container { padding: 0 10px; }
            .content { padding: 20px 15px; }
            .header h1 { font-size: 1.8em; }
            .summary-cards { grid-template-columns: 1fr; }
            .expense-header { flex-direction: column; gap: 10px; align-items: flex-start; }
            .tabs { 
                overflow-x: auto; 
                -webkit-overflow-scrolling: touch;
            }
            .tabs::-webkit-scrollbar { height: 4px; }
            .tabs::-webkit-scrollbar-thumb { background: #dcdde1; border-radius: 2px; }
            .tab { flex-shrink: 0; min-width: 120px; }
            
            .category-breakdown-item {
                flex-direction: column;
                align-items: flex-start;
                gap: 15px;
            }
            .category-breakdown-item > div:first-child { width: 100%; }

            .custom-category-item {
                flex-direction: column;
                align-items: flex-start;
            }
            .category-actions {
                width: 100%;
                margin-top: 15px;
                flex-direction: column-reverse;
                align-items: stretch;
                gap: 10px;
            }
            .category-actions .btn, .category-actions .delete-btn {
                margin: 0;
                text-align: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üí∞ Monthly Expense Tracker</h1>
            <p id="header-subtitle">Track your expenses and share with your partner</p>
        </div>
        <div class="main-card">
            <div class="tabs">
                <button class="tab active" data-tab-name="add" onclick="switchTab(event, 'add')">Add Expense</button>
                <button class="tab" data-tab-name="view" onclick="switchTab(event, 'view')">View Expenses</button>
                <button class="tab" data-tab-name="summary" onclick="switchTab(event, 'summary')">Summary</button>
                <button class="tab" data-tab-name="categories" onclick="switchTab(event, 'categories')">Categories</button>
            </div>
            <div class="content">
                <div id="add-tab" class="tab-content active">
                    <form id="expense-form">
                        <div class="form-group"><label for="date">Date</label><input type="date" id="date" required></div>
                        <div class="form-group"><label for="category">Category</label><select id="category" required><option value="">Select Category</option></select></div>
                        <div class="form-group"><label for="amount">Amount (MYR)</label><input type="number" id="amount" step="0.01" placeholder="0.00" required></div>
                        <div class="form-group"><label for="description">Description</label><textarea id="description" rows="3" placeholder="Enter expense details..." required></textarea></div>
                        <div class="form-group">
                            <label for="receipt">Upload Receipt/Proof</label>
                            <div class="file-upload">
                                <input type="file" id="receipt" accept="image/*,.pdf">
                                <label for="receipt" class="file-upload-label" id="file-label">
                                    <span id="file-label-default">üìÅ Click to upload receipt (optional)</span>
                                    <span id="file-label-selected" style="display: none;"></span>
                                </label>
                                <button type="button" id="remove-file-btn" class="remove-file-btn" style="display: none;">&times;</button>
                            </div>
                            <div class="progress-bar-container" id="progress-container"><div class="progress-bar" id="progress-bar"></div></div>
                        </div>
                        <button type="submit" class="btn">Add Expense</button>
                    </form>
                </div>
                <div id="view-tab" class="tab-content">
                    <div class="filter-section">
                        <select id="filter-month" onchange="filterExpenses()"><option value="">All Months</option></select>
                        <select id="filter-category" onchange="filterExpenses()"><option value="">All Categories</option></select>
                        <button class="btn export-btn" onclick="exportData()">üìä Export Data</button>
                    </div>
                    <div class="expenses-list" id="expenses-list"></div>
                </div>
                <div id="summary-tab" class="tab-content">
                    <div class="summary-cards">
                        <div class="summary-card"><h3>This Month's Salary</h3><div class="amount" id="month-salary">RM 0.00</div></div>
                        <div class="summary-card"><h3>This Month's Expenses</h3><div class="amount" id="month-amount">RM 0.00</div></div>
                        <div class="summary-card"><h3>Remaining Balance</h3><div class="amount" id="remaining-balance">RM 0.00</div></div>
                        <div class="summary-card"><h3>Total Expenses (All Time)</h3><div class="amount" id="total-amount">RM 0.00</div></div>
                    </div>
                    <div id="salary-section" class="expenses-list" style="margin-bottom: 30px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Manage Salary</h3>
                        <form id="salary-form">
                            <div class="form-group">
                                <label for="salary-month">Select Month</label>
                                <input type="month" id="salary-month" required>
                            </div>
                            <div class="form-group">
                                <label for="salary-amount">Salary Amount (MYR)</label>
                                <input type="number" id="salary-amount" step="0.01" placeholder="0.00" required>
                            </div>
                            <button type="submit" class="btn">Save Salary</button>
                        </form>
                    </div>
                    <div class="expenses-list" id="category-breakdown">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Category Breakdown (All Time)</h3>
                        <div id="category-list"></div>
                    </div>
                </div>
                <div id="categories-tab" class="tab-content">
                    <form id="category-form">
                        <div class="form-group"><label for="category-name">Category Name</label><input type="text" id="category-name" placeholder="e.g., Groceries" required></div>
                        <div class="form-group">
                            <label>Choose an Icon</label>
                            <div id="icon-preset-grid"></div>
                            <input type="hidden" id="selected-icon" required>
                        </div>
                        <button type="submit" class="btn">Add Category</button>
                    </form>
                    <div class="expenses-list" id="custom-categories-list" style="margin-top: 30px;">
                        <h3 style="margin-bottom: 20px; color: #2c3e50;">Your Categories</h3>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="edit-category-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header"><h2>Edit Category</h2><button class="modal-close-btn" onclick="hideEditModal()">&times;</button></div>
            <form id="edit-category-form">
                <input type="hidden" id="edit-category-id">
                <div class="form-group"><label for="edit-category-name">Category Name</label><input type="text" id="edit-category-name" required></div>
                <div class="form-group">
                    <label>Choose an Icon</label>
                    <div id="edit-icon-preset-grid"></div>
                    <input type="hidden" id="edit-selected-icon" required>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn">Save Changes</button>
                    <button type="button" class="btn" style="background: #6c757d;" onclick="hideEditModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div id="edit-expense-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Edit Expense</h2>
                <button class="modal-close-btn" onclick="hideEditExpenseModal()">&times;</button>
            </div>
            <form id="edit-expense-form">
                <input type="hidden" id="edit-expense-id">
                <div class="form-group">
                    <label for="edit-date">Date</label>
                    <input type="date" id="edit-date" required>
                </div>
                <div class="form-group">
                    <label for="edit-category">Category</label>
                    <select id="edit-category" required></select>
                </div>
                <div class="form-group">
                    <label for="edit-amount">Amount (MYR)</label>
                    <input type="number" id="edit-amount" step="0.01" required>
                </div>
                <div class="form-group">
                    <label for="edit-description">Description</label>
                    <textarea id="edit-description" rows="3" required></textarea>
                </div>
                <div class="form-group">
                    <label>Receipt</label>
                    <div id="existing-receipt-container">
                        <a id="existing-receipt-link" href="#" target="_blank" rel="noopener noreferrer" class="receipt-link">View Current Receipt</a>
                        <button type="button" id="remove-receipt-btn" class="delete-btn">Remove Receipt</button>
                    </div>
                    <div class="file-upload">
                        <input type="file" id="edit-receipt" accept="image/*,.pdf">
                        <label for="edit-receipt" class="file-upload-label" id="edit-file-label">
                            <span id="edit-file-label-default">üìÅ Click to upload a new receipt</span>
                            <span id="edit-file-label-selected" style="display: none;"></span>
                        </label>
                    </div>
                     <div class="progress-bar-container" id="edit-progress-container"><div class="progress-bar" id="edit-progress-bar"></div></div>
                </div>
                <div class="modal-buttons">
                    <button type="submit" class="btn">Save Changes</button>
                    <button type="button" class="btn" style="background: #6c757d;" onclick="hideEditExpenseModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isViewOnlyMode = urlParams.get('view') === 'true';

        let allExpenses = [];
        let allCategories = [];
        let allSalaries = {};
        const presetIcons = [ 'üè°', 'üí°', 'üíß', 'üåê', 'üõãÔ∏è', 'üì∫', 'üöó', '‚õΩ', 'üõ£Ô∏è', 'üÖøÔ∏è', 'üîß', 'üì±', 'üé¨', 'üéµ', 'üß∏', 'üçº', 'üõí', 'üßΩ', 'üí≥', 'üì¶', 'üç¥', 'üõµ', 'üéÆ', 'üé•', '‚öΩ', 'üé∏', 'üè•', 'üíä', 'üèãÔ∏è', 'üí∞', 'üìà', 'üì∂', 'üë®‚Äçüë©‚Äçüë¶' ];

        async function addToDB(collectionName, data) {
            if (isViewOnlyMode) return false;
            try { await fb.addDoc(fb.collection(db, collectionName), data); return true; } catch (error) { console.error(`Error adding to ${collectionName}:`, error); alert(`Failed to add ${collectionName.slice(0, -1)}.`); return false; }
        }
        
        async function setInDB(collectionName, docId, data) {
            if (isViewOnlyMode) return false;
            try {
                const docRef = fb.doc(db, collectionName, docId);
                await fb.setDoc(docRef, data, { merge: true }); // Using merge to avoid overwriting other fields if any
                return true;
            } catch (error) {
                console.error(`Error setting document in ${collectionName}:`, error);
                alert(`Failed to save ${collectionName.slice(0, -1)}.`);
                return false;
            }
        }

        async function deleteFromDB(collectionName, id) {
            if (isViewOnlyMode) return;
            if (!confirm(`Are you sure you want to delete this ${collectionName.slice(0, -1)}?`)) return;
            const docRef = fb.doc(db, collectionName, id);
            if (collectionName === 'expenses') {
                try {
                    const docSnap = await fb.getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().receipt) {
                        const receiptUrl = docSnap.data().receipt;
                        const fileRef = fb.ref(storage, receiptUrl);
                        await fb.deleteObject(fileRef);
                        console.log("Associated receipt deleted from Storage.");
                    }
                } catch (error) {
                    console.error("Could not delete receipt file.", error);
                }
            }
            try { await fb.deleteDoc(docRef); } catch (error) { console.error(`Error deleting document from ${collectionName}:`, error); }
        }

        function listenForSalaries() {
            fb.onSnapshot(fb.collection(db, "salaries"), (snapshot) => {
                allSalaries = {};
                snapshot.docs.forEach(doc => {
                    allSalaries[doc.id] = doc.data();
                });
                updateDisplay();
            });
        }
        function listenForCategories() {
            const q = fb.query(fb.collection(db, "categories"), fb.orderBy("name", "asc"));
            fb.onSnapshot(q, (snapshot) => {
                allCategories = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                populateCategoryDropdown(); populateCategoryFilter(); displayCategories(); updateDisplay();
            });
        }
        function listenForExpenses() {
            const q = fb.query(fb.collection(db, "expenses"), fb.orderBy("date", "desc"));
            fb.onSnapshot(q, (snapshot) => { allExpenses = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })); updateDisplay(); });
        }

        document.getElementById('expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true; submitBtn.textContent = 'Saving...';
            const fileInput = document.getElementById('receipt');
            let receiptURL = null;
            if (fileInput.files[0]) {
                const file = fileInput.files[0];
                const storageRef = fb.ref(storage, `receipts/${Date.now()}_${file.name}`);
                const uploadTask = fb.uploadBytesResumable(storageRef, file);
                const progressContainer = document.getElementById('progress-container');
                const progressBar = document.getElementById('progress-bar');
                progressContainer.style.display = 'block';
                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed', (snapshot) => { progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`; }, 
                    (error) => { console.error("Upload failed:", error); reject(error); }, 
                    async () => { receiptURL = await fb.getDownloadURL(uploadTask.snapshot.ref); resolve(); });
                });
            }
            const expense = { date: document.getElementById('date').value, category: document.getElementById('category').value, amount: parseFloat(document.getElementById('amount').value), description: document.getElementById('description').value, receipt: receiptURL, timestamp: new Date().toISOString() };
            const success = await addToDB("expenses", expense);
            if (success) { this.reset(); clearFileInput(); flatpickr("#date").setDate("today"); alert('Expense added!'); document.querySelectorAll('.tab[data-tab-name="view"]')[0].click(); }
            submitBtn.disabled = false; submitBtn.textContent = 'Add Expense';
            document.getElementById('progress-container').style.display = 'none'; document.getElementById('progress-bar').style.width = '0%';
        });
        
        document.getElementById('salary-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const monthYear = document.getElementById('salary-month').value;
            const amount = parseFloat(document.getElementById('salary-amount').value);
            if (!monthYear || isNaN(amount)) {
                return alert("Please select a month and enter a valid salary amount.");
            }

            const success = await setInDB("salaries", monthYear, { amount });
            if (success) {
                alert(`Salary for ${monthYear} saved!`);
                this.reset();
                 // Set salary month input to the current month
                const today = new Date();
                const year = today.getFullYear();
                const month = (today.getMonth() + 1).toString().padStart(2, '0');
                document.getElementById('salary-month').value = `${year}-${month}`;
            }
        });

        document.getElementById('category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            const name = document.getElementById('category-name').value;
            const icon = document.getElementById('selected-icon').value;
            if (!name || !icon) { return alert("Please enter a name and select an icon."); }
            const success = await addToDB("categories", { name, icon });
            if (success) { this.reset(); document.getElementById('selected-icon').value = ''; document.querySelector('#icon-preset-grid .icon-preset.selected')?.classList.remove('selected'); alert('Category added!'); }
        });

        document.getElementById('edit-category-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isViewOnlyMode) return;
            const id = document.getElementById('edit-category-id').value;
            const updatedData = { name: document.getElementById('edit-category-name').value, icon: document.getElementById('edit-selected-icon').value };
            try { await fb.updateDoc(fb.doc(db, "categories", id), updatedData); alert("Category updated!"); hideEditModal(); } catch (error) { console.error("Error updating category:", error); alert("Failed to update category."); }
        });
        
        document.getElementById('receipt').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('file-label-default').style.display = 'none';
                const selectedLabel = document.getElementById('file-label-selected');
                selectedLabel.textContent = file.name.length > 30 ? `${file.name.substring(0, 27)}...` : file.name;
                selectedLabel.style.display = 'inline';
                document.getElementById('remove-file-btn').style.display = 'inline-block';
            } else {
                clearFileInput();
            }
        });

        document.getElementById('remove-file-btn').addEventListener('click', clearFileInput);

        function clearFileInput() {
            document.getElementById('receipt').value = '';
            document.getElementById('file-label-default').style.display = 'inline';
            document.getElementById('file-label-selected').style.display = 'none';
            document.getElementById('remove-file-btn').style.display = 'none';
        }

        function updateDisplay() { filterExpenses(); updateSummary(); displayCategories(); populateMonthFilter(); }

        function displayExpenses(filtered = null) {
            const list = document.getElementById('expenses-list');
            const expensesToShow = filtered || allExpenses;
            if (expensesToShow.length === 0) {
                list.innerHTML = `<div class="no-expenses"><div class="no-expenses-icon">üì≠</div><p>No expenses found. Start tracking!</p></div>`;
                return;
            }
            list.innerHTML = expensesToShow.map(exp => {
                const category = allCategories.find(c => c.name === exp.category);
                const icon = category ? category.icon : 'üìå';
                const actionButtons = isViewOnlyMode ? '' : `
                    <div class="expense-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                        <button class="btn" style="padding: 8px 12px; font-size: 14px; background: #ffc107;" onclick="showEditExpenseModal('${exp.id}')">Edit</button>
                        <button class="delete-btn" style="margin-top: 0;" onclick="deleteFromDB('expenses', '${exp.id}')">Delete</button>
                    </div>
                `;
                return `
                <div class="expense-item">
                    <div class="expense-header">
                        <div><span class="expense-category">${icon} ${exp.category}</span></div>
                        <div class="expense-amount">RM ${exp.amount.toFixed(2)}</div>
                    </div>
                    <div class="expense-details">${exp.description}</div>
                    <div class="expense-date">üìÖ ${formatDate(exp.date)}</div>
                    ${exp.receipt ? `<a href="${exp.receipt}" target="_blank" rel="noopener noreferrer" class="receipt-link">View Receipt</a>` : ''}
                    ${actionButtons}
                </div>`;
            }).join('');
        }

        function displayCategories() {
            const list = document.getElementById('custom-categories-list');
            list.innerHTML = '<h3 style="margin-bottom: 20px; color: #2c3e50;">Your Categories</h3>';
            if (allCategories.length === 0) { list.innerHTML += `<p style="text-align: center; color: #8898aa;">No categories yet.</p>`; return; }
            list.innerHTML += allCategories.map(cat => {
                const actionButtons = isViewOnlyMode ? '' : `
                    <button class="btn" style="padding: 8px 16px; margin-top: 0; background: #ffc107;" onclick="showEditModal('${cat.id}', '${cat.name}', '${cat.icon}')">Edit</button>
                    <button class="delete-btn" style="margin-top: 0;" onclick="deleteFromDB('categories', '${cat.id}')">Delete</button>`;
                return `
                <div class="expense-item custom-category-item" style="display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <span style="font-size: 24px; margin-right: 15px;">${cat.icon}</span>
                        <span style="font-weight: 600;">${cat.name}</span>
                    </div>
                    <div class="category-actions">${actionButtons}</div>
                </div>`;
            }).join('');
        }

        function updateSummary() {
            const totalAmount = allExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('total-amount').textContent = `RM ${totalAmount.toFixed(2)}`;
            
            const now = new Date();
            const currentYear = now.getFullYear();
            const currentMonth = now.getMonth();
            const currentMonthStr = `${currentYear}-${(currentMonth + 1).toString().padStart(2, '0')}`;

            const monthExpenses = allExpenses.filter(exp => {
                const d = new Date(exp.date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            });
            const monthTotal = monthExpenses.reduce((sum, exp) => sum + exp.amount, 0);
            document.getElementById('month-amount').textContent = `RM ${monthTotal.toFixed(2)}`;

            const currentMonthSalary = allSalaries[currentMonthStr] ? allSalaries[currentMonthStr].amount : 0;
            document.getElementById('month-salary').textContent = `RM ${currentMonthSalary.toFixed(2)}`;

            const remainingBalance = currentMonthSalary - monthTotal;
            document.getElementById('remaining-balance').textContent = `RM ${remainingBalance.toFixed(2)}`;
            
            const categoryTotals = allExpenses.reduce((acc, exp) => { acc[exp.category] = (acc[exp.category] || 0) + exp.amount; return acc; }, {});
            const list = document.getElementById('category-list');
            if (Object.keys(categoryTotals).length === 0) { list.innerHTML = '<p style="color: #8898aa;">No expenses to analyze</p>'; } else {
                list.innerHTML = Object.entries(categoryTotals).sort((a, b) => b[1] - a[1]).map(([name, amount]) => {
                    const pct = totalAmount > 0 ? (amount / totalAmount * 100).toFixed(1) : 0;
                    const icon = allCategories.find(c => c.name === name)?.icon || 'üìå';
                    return `<div class="expense-item category-breakdown-item"><div style="display: flex; align-items: center; gap: 15px;"><span class="expense-category">${icon} ${name}</span><div style="width: 200px; height: 8px; background: #e1e8ed; border-radius: 4px; overflow: hidden;"><div style="width: ${pct}%; height: 100%; background: linear-gradient(90deg, #667eea, #764ba2);"></div></div></div><div><span style="font-weight: 700;">RM ${amount.toFixed(2)}</span><span style="color: #8898aa; font-size: 14px;"> (${pct}%)</span></div></div>`;
                }).join('');
            }
        }

        function populateIconGrid(gridId, hiddenInputId, selectedIcon = null) {
            const grid = document.getElementById(gridId); grid.innerHTML = '';
            presetIcons.forEach(icon => {
                const el = document.createElement('div'); el.className = 'icon-preset'; el.textContent = icon;
                if (icon === selectedIcon) el.classList.add('selected');
                el.addEventListener('click', () => {
                    grid.querySelector('.selected')?.classList.remove('selected');
                    el.classList.add('selected'); document.getElementById(hiddenInputId).value = icon;
                });
                grid.appendChild(el);
            });
        }
        function populateCategoryDropdown() {
            const select = document.getElementById('category');
            select.innerHTML = '<option value="">Select Category</option>' + allCategories.map(c => `<option value="${c.name}">${c.icon} ${c.name}</option>`).join('');
        }
        function populateCategoryFilter() {
            const select = document.getElementById('filter-category');
            select.innerHTML = '<option value="">All Categories</option>' + allCategories.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
        }
        function populateMonthFilter() {
            const select = document.getElementById('filter-month');
            const months = [...new Set(allExpenses.map(exp => exp.date.substring(0, 7)))].sort().reverse();
            const currentVal = select.value;
            select.innerHTML = '<option value="">All Months</option>' + months.map(m => {
                const [y, n] = m.split('-'); const d = new Date(y, n - 1);
                return `<option value="${m}">${d.toLocaleDateString('en-US', { month: 'long', year: 'numeric' })}</option>`;
            }).join('');
            select.value = currentVal;
        }

        function filterExpenses() {
            const month = document.getElementById('filter-month').value; const category = document.getElementById('filter-category').value;
            let filtered = allExpenses;
            if (month) filtered = filtered.filter(e => e.date.startsWith(month));
            if (category) filtered = filtered.filter(e => e.category === category);
            displayExpenses(filtered);
        }
        function switchTab(e, name) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active')); e.currentTarget.classList.add('active');
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active')); document.getElementById(`${name}-tab`).classList.add('active');
            updateDisplay();
        }
        function formatDate(dateStr) { const d = new Date(dateStr); return d.toLocaleDateString('en-MY', { timeZone: 'UTC', year: 'numeric', month: 'long', day: 'numeric' }); }
        function exportData() {
            if (isViewOnlyMode) return;
            const dataStr = JSON.stringify({ expenses: allExpenses, categories: allCategories, salaries: allSalaries }, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' }); const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `expenses_data_${new Date().toISOString().split('T')[0]}.json`;
            a.click(); URL.revokeObjectURL(url);
        }
        function showEditModal(id, name, icon) {
            if (isViewOnlyMode) return;
            document.getElementById('edit-category-id').value = id; document.getElementById('edit-category-name').value = name;
            document.getElementById('edit-selected-icon').value = icon;
            populateIconGrid('edit-icon-preset-grid', 'edit-selected-icon', icon);
            document.getElementById('edit-category-modal').style.display = 'flex';
        }
        function hideEditModal() { document.getElementById('edit-category-modal').style.display = 'none'; }
        
        async function showEditExpenseModal(expenseId) {
            if (isViewOnlyMode) return;

            const expense = allExpenses.find(exp => exp.id === expenseId);
            if (!expense) {
                alert("Expense not found!");
                return;
            }

            document.getElementById('edit-expense-id').value = expense.id;
            document.getElementById('edit-date').value = expense.date;
            document.getElementById('edit-amount').value = expense.amount;
            document.getElementById('edit-description').value = expense.description;

            const categorySelect = document.getElementById('edit-category');
            categorySelect.innerHTML = allCategories.map(c => `<option value="${c.name}" ${expense.category === c.name ? 'selected' : ''}>${c.icon} ${c.name}</option>`).join('');

            const existingReceiptContainer = document.getElementById('existing-receipt-container');
            const existingReceiptLink = document.getElementById('existing-receipt-link');
            if (expense.receipt) {
                existingReceiptLink.href = expense.receipt;
                existingReceiptContainer.style.display = 'block';
            } else {
                existingReceiptContainer.style.display = 'none';
            }
            
            document.getElementById('edit-receipt').value = '';
            document.getElementById('edit-file-label-default').style.display = 'inline';
            document.getElementById('edit-file-label-selected').style.display = 'none';


            document.getElementById('edit-expense-modal').style.display = 'flex';
            flatpickr("#edit-date", { dateFormat: "Y-m-d" });
        }

        function hideEditExpenseModal() {
            document.getElementById('edit-expense-modal').style.display = 'none';
        }

        function setupViewOnlyUI() {
            if (!isViewOnlyMode) return;
            document.getElementById('header-subtitle').textContent = "View-Only Access";
            document.querySelector('.tab[data-tab-name="add"]').style.display = 'none';
            document.querySelector('.tab[data-tab-name="categories"]').style.display = 'none';
            document.getElementById('salary-section').style.display = 'none';
            document.querySelector('.export-btn').style.display = 'none';
            document.querySelectorAll('.tab[data-tab-name="view"]')[0].click();
        }

        document.getElementById('edit-expense-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            if (isViewOnlyMode) return;

            const submitBtn = this.querySelector('button[type="submit"]');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Saving...';

            const expenseId = document.getElementById('edit-expense-id').value;
            const originalExpense = allExpenses.find(exp => exp.id === expenseId);
            let newReceiptURL = originalExpense.receipt;

            const fileInput = document.getElementById('edit-receipt');
            if (fileInput.files[0]) {
                if (originalExpense.receipt) {
                    try {
                        const oldFileRef = fb.ref(storage, originalExpense.receipt);
                        await fb.deleteObject(oldFileRef);
                    } catch (error) {
                        console.error("Could not delete the old receipt file.", error);
                    }
                }
                
                const file = fileInput.files[0];
                const storageRef = fb.ref(storage, `receipts/${Date.now()}_${file.name}`);
                const uploadTask = fb.uploadBytesResumable(storageRef, file);
                const progressContainer = document.getElementById('edit-progress-container');
                const progressBar = document.getElementById('edit-progress-bar');
                progressContainer.style.display = 'block';

                await new Promise((resolve, reject) => {
                    uploadTask.on('state_changed',
                        (snapshot) => {
                            progressBar.style.width = `${(snapshot.bytesTransferred / snapshot.totalBytes) * 100}%`;
                        },
                        (error) => {
                            console.error("Upload failed:", error);
                            reject(error);
                        },
                        async () => {
                            newReceiptURL = await fb.getDownloadURL(uploadTask.snapshot.ref);
                            resolve();
                        }
                    );
                });
            }

            const updatedData = {
                date: document.getElementById('edit-date').value,
                category: document.getElementById('edit-category').value,
                amount: parseFloat(document.getElementById('edit-amount').value),
                description: document.getElementById('edit-description').value,
                receipt: newReceiptURL,
            };

            try {
                const docRef = fb.doc(db, "expenses", expenseId);
                await fb.updateDoc(docRef, updatedData);
                alert("Expense updated successfully!");
                hideEditExpenseModal();
            } catch (error) {
                console.error("Error updating expense:", error);
                alert("Failed to update expense.");
            } finally {
                submitBtn.disabled = false;
                submitBtn.textContent = 'Save Changes';
                const progressContainer = document.getElementById('edit-progress-container');
                if(progressContainer) {
                   progressContainer.style.display = 'none';
                   document.getElementById('edit-progress-bar').style.width = '0%';
                }
            }
        });

        document.getElementById('edit-receipt').addEventListener('change', function() {
            const file = this.files[0];
            if (file) {
                document.getElementById('edit-file-label-default').style.display = 'none';
                const selectedLabel = document.getElementById('edit-file-label-selected');
                selectedLabel.textContent = file.name.length > 30 ? `${file.name.substring(0, 27)}...` : file.name;
                selectedLabel.style.display = 'inline';
            } else {
                document.getElementById('edit-file-label-default').style.display = 'inline';
                document.getElementById('edit-file-label-selected').style.display = 'none';
            }
        });

        document.getElementById('remove-receipt-btn').addEventListener('click', async function() {
            if (isViewOnlyMode) return;
            
            const expenseId = document.getElementById('edit-expense-id').value;
            if (!expenseId) return;

            if (confirm("Are you sure you want to remove the receipt for this expense? This cannot be undone.")) {
                const originalExpense = allExpenses.find(exp => exp.id === expenseId);
                if (originalExpense && originalExpense.receipt) {
                    try {
                        const fileRef = fb.ref(storage, originalExpense.receipt);
                        await fb.deleteObject(fileRef);

                        const docRef = fb.doc(db, "expenses", expenseId);
                        await fb.updateDoc(docRef, { receipt: null });
                        
                        alert("Receipt removed.");
                        document.getElementById('existing-receipt-container').style.display = 'none';

                    } catch (error) {
                        console.error("Error removing receipt:", error);
                        alert("Failed to remove receipt.");
                    }
                }
            }
        });

        document.addEventListener('DOMContentLoaded', () => {
            flatpickr("#date", { dateFormat: "Y-m-d", defaultDate: "today" });
            const today = new Date();
            const year = today.getFullYear();
            const month = (today.getMonth() + 1).toString().padStart(2, '0');
            document.getElementById('salary-month').value = `${year}-${month}`;
            
            populateIconGrid('icon-preset-grid', 'selected-icon');
            listenForSalaries();
            listenForCategories();
            listenForExpenses();
            setupViewOnlyUI();
        });
    </script>
</body>
</html>
